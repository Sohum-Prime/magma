# magma.sandbox

> **Status** | v0.1.0 | Experimental  
> **Depends on** | `smolagents >= 0.4`, `wasmtime`, `docker`, `e2b-code-interpreter`, `pydantic`  
> (Only the runner you pick is actually imported at runtime.)

---

## 1 · Purpose & Mental Model
`magma.sandbox` supplies **secure, language‑level isolation** for code generated by CodeAgent‑style prompts.  
Instead of running LLM‑authored Python in your host process, we delegate execution to a pluggable sandbox runner:

| Runner class | Isolation tech | Default network | File‑system | Deployment ease |
|--------------|----------------|-----------------|-------------|-----------------|
| `LocalPython` | smolagents’ AST interpreter | DENY | tmpfs | 0‑setup |
| `Wasm`        | Pyodide + WASI (via Deno)    | DENY | virtual FS | Deno install |
| `Docker`      | Docker container            | ALLOW*¹ | bind‑mount RO | local Docker daemon |
| `E2B`         | e2b micro‑VM (remote)       | ALLOW | ephemeral | cloud key |

*¹ outgoing only; can be restricted with `--network none`.

A **single façade API** lets CodeAgent choose the sandbox at runtime (`from_env()` or explicit).

---

## 2 · Quick‑start

```python
from magma.sandbox import LocalPython, from_env

code = "result = sum(range(10))"

# Most explicit
with LocalPython(allowed_imports=["math"]) as box:
    res, logs = box.run(code, timeout=2)
    print(res)   # -> 45

# Environment‑driven (export MAGMA_SANDBOX_TYPE=docker)
with from_env() as box:
    res, _ = box.run(code)
````

---

## 3 · Public API

### 3.1 Symbol overview

| Symbol                                 | Type        | Description                         |
| -------------------------------------- | ----------- | ----------------------------------- |
| `Sandbox`                              | ABC         | Common interface for all runners    |
| `LocalPython`, `Docker`, `E2B`, `Wasm` | subclasses  | Concrete executors                  |
| `from_env()`                           | helper      | Factory: reads `MAGMA_SANDBOX_TYPE` |
| `SandboxError`                         | `Exception` | Base error for sandbox failures     |

### 3.2 Key signatures

```python
class Sandbox(ABC):
    def __enter__(self) -> "Sandbox": ...
    def __exit__(self, exc_type, exc, tb): ...

    @abstractmethod
    def run(self, code: str, /, *, timeout: int = 10) -> tuple[Any, str]:
        """
        Execute Python source in the sandbox.

        Returns (result, logs).
        Raises SandboxError on timeout or security violation.
        """
```

```python
def from_env() -> Sandbox:
    """
    Factory that returns a sandbox instance based on
    env `MAGMA_SANDBOX_TYPE` (localpython|wasm|docker|e2b).
    Defaults to LocalPython.
    """
```

> *Gotchas*
> • `allowed_imports` for `LocalPython` defaults to a safe whitelist (`math`, `random`, `json`, …).
> • `Docker` runner pulls image `magma/code-sandbox:py310` on first use (auto‑built).
> • `E2B` requires `E2B_API_KEY` env; raises at construction otherwise.

---

## 4 · Design Notes

* **Thin proxy** – code for each runner lives mostly in smolagents; magma just standardises method names and logging.
* **Resource limits** – wrappers set sensible defaults (CPU=0.5, MEM=512 MiB, timeout=10 s). Users can override per‑call.
* **Stateless** – every `run()` call creates a fresh interpreter/ container / VM, ensuring no cross‑call leakage.
* **Logging** – both `stdout`/`stderr` streamed; combined text returned as second tuple element.
* **Security first** – local runners default to *no* network; enabling outbound requires explicit `allow_network=True`.

---

## 5 · Extensibility Hooks

| Hook                     | Usage                                                                           | Scenario                      |
| ------------------------ | ------------------------------------------------------------------------------- | ----------------------------- |
| **Custom runner**        | Subclass `Sandbox` and register via `magma.sandbox.register("mybox", MyRunner)` | Internal HPC cluster executor |
| **Import allow‑list**    | `LocalPython(allowed_imports=["numpy", "pandas.*"])`                            | Data‑science heavy code       |
| **Network toggle**       | `Docker(..., allow_network=False)`                                              | Offline evaluation            |
| **Env factory override** | `export MAGMA_SANDBOX_FACTORY=corp.pkg.factory_fn`                              | Org‑wide default policy       |

---

## 6 · Integration Points

| External                    | Interaction                                          | Notes                                        |
| --------------------------- | ---------------------------------------------------- | -------------------------------------------- |
| **magma.tool**              | Reads `ToolInfo.allow_modules` to extend import list | Automatic safety alignment                   |
| **magma.agent (CodeAgent)** | Each code‑generation node calls `Sandbox.run()`      | Chosen runner injected at agent construction |
| **magma.trace**             | Wrapper creates `span("sandbox:<runner>")`           | Latency & resource metrics                   |

---

## 7 · Reference Implementation Roadmap

| Phase  | Scope                                     | Tests                              |
| ------ | ----------------------------------------- | ---------------------------------- |
| **P1** | `Sandbox` ABC + `LocalPython`             | Verify import deny/allow & timeout |
| **P2** | `from_env()` + env var factory            | Parametrised test over env values  |
| **P3** | `Docker` runner with security opts        | CI w/ `docker-in-docker`           |
| **P4** | `E2B` & `Wasm` runners (optional install) | Mock e2b; Deno smoke test          |

---

## 8 · Changelog Snippet


### Added
- `magma.sandbox`: pluggable secure code execution layer with LocalPython, Docker, E2B and Wasm runners.
- `from_env()` factory selecting runner via `MAGMA_SANDBOX_TYPE`.
